<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial; padding: 20px; }
        #messages { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; margin-bottom: 10px; }
        .message { margin: 5px; padding: 8px; border-radius: 5px; }
        .my { background: #d1ecf1; text-align: right; }
        .other { background: #f8d7da; text-align: left; }
    </style>
</head>
<body>
    <h2>Тест отправки сообщений</h2>
    
    <div>
        Мой ID: <input type="number" id="myId" value="1">
        ID собеседника: <input type="number" id="otherId" value="2">
        <button onclick="loadMessages()">Загрузить</button>
    </div>
    
    <div id="messages">Сообщения появятся здесь...</div>
    
    <div>
        <input type="text" id="messageInput" placeholder="Введите сообщение..." style="width: 300px;">
        <button onclick="sendMessage()">Отправить</button>
    </div>
    
    <script>
    async function loadMessages() {
        const myId = document.getElementById('myId').value;
        const otherId = document.getElementById('otherId').value;
        
        const response = await fetch(`api/messages/get.php?user1_id=${myId}&user2_id=${otherId}`);
        const data = await response.json();
        
        const container = document.getElementById('messages');
        container.innerHTML = '';
        
        if (data.success && data.messages) {
            data.messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = `message ${msg.sender_id == myId ? 'my' : 'other'}`;
                div.innerHTML = `
                    <strong>${msg.sender_display_name || msg.sender_name}</strong><br>
                    ${msg.message}<br>
                    <small>${new Date(msg.created_at).toLocaleTimeString()}</small>
                `;
                container.appendChild(div);
            });
            
            container.scrollTop = container.scrollHeight;
        } else {
            container.innerHTML = 'Нет сообщений или ошибка: ' + (data.error || '');
        }
    }
    
    async function sendMessage() {
        const myId = document.getElementById('myId').value;
        const otherId = document.getElementById('otherId').value;
        const input = document.getElementById('messageInput');
        const text = input.value.trim();
        
        if (!text) return;
        
        const response = await fetch('api/messages/send.php', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                sender_id: myId,
                receiver_id: otherId,
                message: text
            })
        });
        
        const data = await response.json();
        console.log('Отправка:', data);
        
        if (data.success) {
            input.value = '';
            loadMessages(); // Обновляем сообщения
        } else {
            alert('Ошибка: ' + data.error);
        }
    }
    
    // Автообновление
    setInterval(loadMessages, 2000);
    
    // Загружаем при старте
    loadMessages();
    </script>
</body>
</html>